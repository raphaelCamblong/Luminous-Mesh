version: '3'

includes:
  core: ./core/Taskfile.yml
  api-gateway: ./api-gateway/Taskfile.yml
  data-store: ./data-store/Taskfile.yml

vars:
  BUILD_DIR: .build
  PLUGINS_DIR: '{{.BUILD_DIR}}/plugins'

tasks:
  clean:
    desc: Clean build artifacts
    cmds:
      - rm -rf {{.BUILD_DIR}}

  create-dirs:
    desc: Create build directories
    cmds:
      - mkdir -p {{.BUILD_DIR}}
      - mkdir -p {{.PLUGINS_DIR}}

  build:
    desc: Build everything
    deps: [create-dirs, api-gateway:build, core:build]

  test:
    desc: Run all tests
    cmds:
      - go test -v ./...

  run:
    desc: Run core
    cmds:
      - ./{{.BUILD_DIR}}/control-plane

  default:
    desc: Default task
    deps: [build]